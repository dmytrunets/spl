#!/bin/bash
# Setting prjoect to working state

cmd='php app/console'

mkdir app/cache
mkdir app/logs

USER=$(whoami)
APACHE_USER=$(ps axho user,comm|grep -E "httpd|apache"|uniq|grep -v "root"|awk 'END {print $1}')
chcache () {
    sudo chmod +a "$USER allow delete,write,append,file_inherit,directory_inherit" $1
    sudo chmod +a "$APACHE_USER allow delete,write,append,file_inherit,directory_inherit" $1
    echo "- $1 has been properly chmod'ed for $USER and $APACHE_USER"                                                   
}                                                                                                                       
if [ -d app/cache ];   then chcache "app/cache"; fi                                                                     
if [ -d app/logs ];    then chcache "app/logs"; fi
if [ -d web/uploads ]; then chcache "web/uploads"; fi

cp app/config/parameters.yml.dist app/config/parameters.yml
$EDITOR app/config/parameters.yml

if [[ ! -e composer.phar ]]; then
    curl -s https://getcomposer.org/installer | php
fi
php composer.phar install

$cmd doctrine:database:create
$cmd doctrine:migrations:migrate --no-interaction
$cmd doctrine:fixtures:load --append
$cmd cache:warmup